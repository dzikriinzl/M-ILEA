"""
Vulnerability Visualization Module

Creates charts and visualizations for vulnerability data:
- OWASP MSTG category breakdown
- Severity distribution
- Top vulnerable areas
"""

from typing import Dict, List
import json


class VulnerabilityVisualizer:
    """Generate vulnerability visualization data"""
    
    @staticmethod
    def prepare_severity_chart(vulnerabilities: List) -> Dict:
        """Prepare severity distribution for chart"""
        
        severity_counts = {
            "Critical": 0,
            "High": 0,
            "Medium": 0,
            "Low": 0,
            "Info": 0,
        }
        
        for vuln in vulnerabilities:
            sev = vuln.get('severity', 'Info') if isinstance(vuln, dict) else getattr(vuln, 'severity', 'Info')
            if sev in severity_counts:
                severity_counts[sev] += 1
        
        return {
            "type": "bar",
            "title": "Vulnerability Severity Distribution",
            "data": {
                "labels": list(severity_counts.keys()),
                "datasets": [{
                    "label": "Count",
                    "data": list(severity_counts.values()),
                    "backgroundColor": [
                        "#dc2626",  # Critical: red
                        "#ea580c",  # High: orange
                        "#eab308",  # Medium: yellow
                        "#22c55e",  # Low: green
                        "#64748b",  # Info: gray
                    ]
                }]
            },
        }
    
    @staticmethod
    def prepare_category_chart(vulnerabilities: List) -> Dict:
        """Prepare OWASP MSTG category breakdown for chart"""
        
        categories = {}
        
        for vuln in vulnerabilities:
            category = vuln.get('category') if isinstance(vuln, dict) else getattr(vuln, 'category', 'Unknown')
            categories[category] = categories.get(category, 0) + 1
        
        return {
            "type": "doughnut",
            "title": "Vulnerabilities by OWASP MSTG Category",
            "data": {
                "labels": list(categories.keys()),
                "datasets": [{
                    "data": list(categories.values()),
                    "backgroundColor": [
                        "#3b82f6", "#8b5cf6", "#ec4899", "#f59e0b", "#10b981",
                        "#06b6d4", "#6366f1", "#d946ef"
                    ]
                }]
            },
        }


def get_vulnerability_html_card(vulnerabilities: List, metadata: Dict) -> str:
    """Generate vulnerability card HTML"""
    
    severity_counts = {"Critical": 0, "High": 0, "Medium": 0, "Low": 0}
    
    for v in vulnerabilities:
        sev = v.get('severity') if isinstance(v, dict) else getattr(v, 'severity', 'Low')
        if sev in severity_counts:
            severity_counts[sev] += 1
    
    total = sum(severity_counts.values())
    
    return f"""
    <div class="card vulnerability-card">
        <h2>Vulnerability Analysis</h2>
        <div class="vuln-grid">
            <div class="vuln-stat critical">
                <span class="vuln-num">{severity_counts['Critical']}</span>
                <span>Critical</span>
            </div>
            <div class="vuln-stat high">
                <span class="vuln-num">{severity_counts['High']}</span>
                <span>High</span>
            </div>
            <div class="vuln-stat medium">
                <span class="vuln-num">{severity_counts['Medium']}</span>
                <span>Medium</span>
            </div>
            <div class="vuln-stat low">
                <span class="vuln-num">{severity_counts['Low']}</span>
                <span>Low</span>
            </div>
        </div>
        <div class="vuln-summary" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); color: var(--text-secondary); font-size: 0.9rem;">
            <p><strong>Total Issues Found:</strong> {total}</p>
        </div>
    </div>
    """
